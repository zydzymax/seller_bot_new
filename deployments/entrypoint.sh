#!/bin/bash
# entrypoint.sh ‚Äî –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ AI-–ø—Ä–æ–¥–∞–≤—Ü–∞ —Å –∞—É–¥–∏–æ –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π
# ¬© SoVAni 2025

set -e

echo "üöÄ –ó–∞–ø—É—Å–∫ AI-–ø—Ä–æ–¥–∞–≤—Ü–∞ SoVAni..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -z "$TELEGRAM_TOKEN" ]; then
    echo "‚ùå TELEGRAM_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    exit 1
fi

if [ -z "$OPENAI_API_KEY" ]; then
    echo "‚ö†Ô∏è OPENAI_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω - –∞—É–¥–∏–æ —Ñ—É–Ω–∫—Ü–∏–∏ –±—É–¥—É—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
fi

if [ -z "$ANTHROPIC_API_KEY" ]; then
    echo "‚ö†Ô∏è ANTHROPIC_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
mkdir -p /tmp/ai_seller_audio
chmod 755 /tmp/ai_seller_audio

echo "üìÅ –í—Ä–µ–º–µ–Ω–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –∞—É–¥–∏–æ: /tmp/ai_seller_audio"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∞—É–¥–∏–æ –±–∏–±–ª–∏–æ—Ç–µ–∫
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É–¥–∏–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
python3 -c "import aiohttp, aiofiles; print('‚úÖ –ê—É–¥–∏–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ã')" || {
    echo "‚ùå –û—à–∏–±–∫–∞: –∞—É–¥–∏–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
    exit 1
}

# –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∞—É–¥–∏–æ —Ñ–∞–π–ª—ã –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∞—É–¥–∏–æ —Ñ–∞–π–ª–æ–≤..."
find /tmp/ai_seller_audio -name "*.mp3" -mtime +1 -delete 2>/dev/null || true
find /tmp/ai_seller_audio -name "*.ogg" -mtime +1 -delete 2>/dev/null || true

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º –∑–∞–ø—É—Å–∫–∞
MODE=${1:-"both"}

case $MODE in
    "go")
        echo "üü¢ –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ Go API —Å–µ—Ä–≤–µ—Ä–∞..."
        exec /app/go-api-server
        ;;
    "python")
        echo "üêç –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ Python Telegram –±–æ—Ç–∞..."
        cd /app/python-core
        exec python -m bot.telegram_bot
        ;;
    "both"|*)
        echo "üîÑ –ó–∞–ø—É—Å–∫ –æ–±–æ–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤..."
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º Go API –≤ —Ñ–æ–Ω–µ
        echo "üü¢ –ó–∞–ø—É—Å–∫ Go API —Å–µ—Ä–≤–µ—Ä–∞ –≤ —Ñ–æ–Ω–µ..."
        /app/go-api-server &
        GO_PID=$!
        
        # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ Go —Å–µ—Ä–≤–µ—Ä–∞
        sleep 3
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º Python –±–æ—Ç–∞
        echo "üêç –ó–∞–ø—É—Å–∫ Python Telegram –±–æ—Ç–∞..."
        cd /app/python-core
        python -m bot.telegram_bot &
        PYTHON_PID=$!
        
        # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        cleanup() {
            echo "üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è..."
            echo "‚è≥ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ Go API —Å–µ—Ä–≤–µ—Ä–∞..."
            kill -TERM $GO_PID 2>/dev/null || true
            echo "‚è≥ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ Python –±–æ—Ç–∞..."
            kill -TERM $PYTHON_PID 2>/dev/null || true
            
            # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
            wait $GO_PID 2>/dev/null || true
            wait $PYTHON_PID 2>/dev/null || true
            
            echo "‚úÖ –í—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã."
            exit 0
        }
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤
        trap cleanup SIGTERM SIGINT
        
        echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã. PID Go: $GO_PID, PID Python: $PYTHON_PID"
        echo "üéØ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è..."
        
        # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ª—é–±–æ–≥–æ –∏–∑ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
        wait -n
        
        # –ï—Å–ª–∏ –æ–¥–∏–Ω –∏–∑ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è, –∑–∞–≤–µ—Ä—à–∞–µ–º –≤—Å–µ
        cleanup
        ;;
esac